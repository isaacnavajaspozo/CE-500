#=========================================================================================================================
[‚õ©Ô∏èce-500]::
# Documentaci√≥n oficial SSH            : https://www.openssh.com/
# Documentaci√≥n no-oficial             : https://synay.net/es/support/kb/disabling-automatic-workstation-sleep-debian-12
# Documentaci√≥n oficial de iptables:   : https://www.netfilter.org/documentation/HOWTO/es/packet-filtering-HOWTO-7.html

#=========================================================================================================================
[‚õ©Ô∏èINSTALACIONES]::
# Instalaciones generales
apt install -y htop lm-sensors vim net-tools openssh-server iptables iptables-persistent fail2ban

#=========================================================================================================================
[‚õ©Ô∏èCONFIGURACI√ìN DE LA RED]::
# Compruebo ip por DHCP
ifconfig

# desactivo ip6
sudo nano /etc/default/grub
----------------------------------------------------------------------------
    GRUB_CMDLINE_LINUX_DEFAULT="quiet splash ipv6.disable=1"
----------------------------------------------------------------------------
sudo update-grub

# Configuro el host
nano /etc/hostname
----------------------------------------------------------------------------
    ce-500.com
----------------------------------------------------------------------------

# Configuraci√≥n archivo host
# host -> ce-500.com | alias -> ce-500
sudo nano /etc/hosts
----------------------------------------------------------------------------
    127.0.0.1               localhost
    127.0.0.1               ce-500.com    ce-500
    
    # The following lines are desirable for IPv6 capable hosts
    ::1     localhost ip6.localhost ip6.loopback localhost.localdomain 
 
    # Multicast (solo IPv6)
    # ff02::1     ip6-allnodes
    # ff02::2     ip6-allrouters
----------------------------------------------------------------------------

# Cambiar ip est√°tica
nano /etc/network/interfaces
----------------------------------------------------------------------------
    # Configuraci√≥n de la interfaz WiFi
    # This file describes the network interfaces available on your system
    # and how to activate them. For more information, see interfaces(5).
    
    source /etc/network/interfaces.d/*
    
    # The loopback network interface
    auto lo
    iface lo inet loopback
      
    # La interfaz Ethernet (configuraci√≥n est√°tica)
     auto eno1
     iface eno1 inet static
       address <LA_MISMA_IP_DHCP_ANTERIOR>
             netmask 255.255.255.0
             gateway <PUERTA_DE_ENLACE>
             dns-nameservers 8.8.8.8 1.1.1.1
    
     # The primary network interface
     #allow-hotplug wlp3s0
     #iface wlp3s0 inet dhcp
     #   wpa-ssid <SSID_WIFI>
     #   wpa-psk  <PASSWORD_WIFI>
----------------------------------------------------------------------------

# Reinicio la red
systemctl restart networking
systemctl status networking

# Reinicio la m√°quina
sudo reboot

#=========================================================================================================================
[‚õ©Ô∏èINSTALACI√ìN SSH]::
# Amplio tiempo de ssh y deshabilitar la suspensi√≥n
systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

# Realizo unos cambios en el archivo de configuraci√≥n
nano /etc/ssh/sshd_config
----------------------------------------------------------------------------
    Port 22
    PasswordAuthentication yes
----------------------------------------------------------------------------

# Inicializo el servicio y lo habilito para inicio de la sesi√≥n
systemctl start sshd
systemctl status sshd
systemctl enable sshd

#=========================================================================================================================
[‚õ©Ô∏èCREO USUARIOS NECESARIOS]::
# creo script para generar contrase√±a

cd / && mkdir ce-500
cd /ce-500
vim bcrypt_hash.sh
----------------------------------------------------------------------------
#!/bin/bash
# Verificar si apache2-utils est√° instalado
if ! dpkg -l | grep -q apache2-utils; then
    echo "apache2-utils no est√° instalado. Instalando..."
    sudo apt-get update
    sudo apt-get install -y apache2-utils
fi
# Verificar si se proporcion√≥ una contrase√±a
if [ -z "$1" ]; then
    echo "Uso: $0 <contrase√±a>"
    exit 1
fi

# Usar htpasswd para generar el hash bcrypt
HASH=$(htpasswd -bnB "" "$1" | cut -d: -f2)

# Mostrar el hash
echo "Hash bcrypt: $HASH"
----------------------------------------------------------------------------

# doy permisos al script 
chmod +x bcrypt_hash.sh

# ejecuto script
./bcrypt_hash.sh <TU_CONTRASE√ëA>

# Debian utiliza la encriptaci√≥n bcrypt para validar usuarios
# A√±ado usuario con privilegios de root
useradd --comment "<NOMBRE_DE_USUARIO> - Admin" --uid 0 --gid 0 --non-unique -m -s /bin/bash \
-p '' <NOMBRE_DE_USUARIO>
ln -sf /root/.bashrc /home/<NOMBRE_DE_USUARIO>/.bashrc
ln -sf /root/.vimrc /home/<NOMBRE_DE_USUARIO>/.vimrc
ln -sf /root/.selected_editor /home/<NOMBRE_DE_USUARIO>/.selected_editor 

# Eliminar usuario innecesarios
cat /etc/passwd
sudo userdel -r <NOMBRE_DE_USUARIO>

#=========================================================================================================================
[‚õ©Ô∏èAJUSTES DEL SERVIDOR]::
# Me registro con el usuario
# Modifico configuraci√≥n de terminal de usuario (lo agrego al final de los alias, antes de  if [ -f ~/.bash_aliases ]; then...)
nano ~/.bashrc
----------------------------------------------------------------------------
    ## alias del servidor    
    alias ls='ls --color=auto'
    alias la='ls $LS_OPTIONS -lhai'
    alias _liberarespacioram='sudo sync; echo 1 | sudo tee /proc/sys/vm/drop_caches | echo "petici√≥n realizada correctamente." && echo "" && free -h'
    alias _ce-500='/ce-500/KIRIBAKO.sh'

    
    ## Cambiar dise√±o del prompt
    PS1='${debian_chroot:+($debian_chroot)}\[\e[0;90m\]r00tÁÆ±\[\e[1;36m\][\H]\e[1;36m\]\e[1;32m \w\e[0;37m $: '

    ## cambiar colores para ls
    # color-verde:    directorios
    # color-blanco:   archivos normales
    # color-magenta:  enlaces simbolicos
    # color-amarillo: directorios bloqueados, enlaces especiales, dispositivos de bloque y los de caracter
    # color-rojo:     archivos hu√©rfanos, archivos bloqueados, archivos ejecutables (negrita)
    # color azul:     FIFO
    export LS_COLORS="di=1;32:fi=0;37:ln=1;35:so=0;38;5;208:pi=0;34:bd=0;33:cd=0;33:or=0;31:mi=0;31:ex=1;31"
----------------------------------------------------------------------------
source ~/.bashrc

#=========================================================================================================================
[‚õ©Ô∏èCONFIGURACI√ìN DE VIM]::
# # creo el archivo vimrc
sudo nano ~/.vimrc

# archivo .vimrc
----------------------------------------------------------------------------
    " configuraci√≥n archivo .vimrc
    "=========================================================
    " Habilitar numeraci√≥n de l√≠neas
    set number
    " Resaltar la l√≠nea actual
    set cursorline
    " Habilitar el uso del mouse (si se habilita no permite copia y pegar en ssh)
    "set mouse=a
    " Mantener el cursor centrado al desplazarse
    set scrolloff=8
    " Habilitar la b√∫squeda incremental
    set incsearch
    " Resaltar coincidencias de b√∫squeda
    set hlsearch
    " Ignorar may√∫sculas y min√∫sculas en las b√∫squedas
    set ignorecase
    set smartcase
    " Usar espacios en lugar de tabulaciones
    set expandtab
    set tabstop=4          " N√∫mero de espacios para un tabulador
    set shiftwidth=4       " N√∫mero de espacios para el autoindentar
    " Habilitar el modo de autocompletar
    set wildmenu
    " Habilitar el plegado de texto
    set foldmethod=indent
    set foldlevel=99       " Plegar autom√°ticamente
    " Configurar el esquema de color
    syntax on              " Activar la sintaxis
    set background=dark    " Para temas oscuros
    colorscheme industry  " Cambiar el esquema de color (puedes cambiar 'industry' o 'blue' entre otros)
    highlight Comment ctermfg=Green guifg=#00FF00        " Color para comentarios en el c√≥digo
    highlight LineNr ctermfg=Magenta                     " Color para n√∫meros de l√≠nea en el margen
    highlight CursorLineNr ctermfg=DarkMagenta           " Color para el n√∫mero de l√≠nea de la l√≠nea actual
    highlight Normal ctermfg=White ctermbg=DarkGray      " Color de fondo y texto del √°rea principal
    highlight Keyword ctermfg=LightGray                  " Color para palabras clave del lenguaje
    highlight Function ctermfg=Yellow                    " Color para nombres de funciones
    highlight Type ctermfg=Magenta                       " Color para tipos de datos (int, float, etc.)
    highlight Constant ctermfg=Magenta                   " Color para constantes (n√∫meros, booleanos)
    highlight Identifier ctermfg=White                   " Color para identificadores (nombres de variables)
    highlight Statement ctermfg=Yellow                   " Color para sentencias del lenguaje (return, break, etc.)
    highlight Error ctermfg=White ctermbg=Red            " Color para errores de sintaxis
    highlight Search ctermfg=Black ctermbg=Yellow        " Color para coincidencias de b√∫squeda
    highlight Visual ctermbg=Grey                        " Color de fondo para selecci√≥n en modo visual
    highlight Keyword ctermfg=White                      " (Redundante) Color para palabras clave del lenguaje
    highlight StatusLine ctermfg=Blue ctermbg=White      " Color para la l√≠nea de estado activa
    highlight StatusLineNC ctermfg=Blue ctermbg=DarkGray " Color para la l√≠nea de estado inactiva
    highlight Special ctermfg=Blue                       " Color para s√≠mbolos especiales (@, #, etc.)
    highlight PreProc ctermfg=Grey                       " Color para preprocesadores (por ejemplo, en C/C++)
    highlight Type ctermfg=Grey                          " Color para tipos de datos (redundante)
    highlight Todo ctermfg=Black ctermbg=Yellow          " Color para tareas pendientes (TODO, FIXME, etc.)
    highlight Underlined ctermfg=White                   " Color para texto subrayado
    highlight Pmenu ctermbg=DarkGray                     " Color de fondo del men√∫ emergente (completado)
    highlight PmenuSel ctermbg=Blue ctermfg=White        " Color de fondo y texto del elemento seleccionado en el men√∫
    highlight DiffAdd ctermbg=Green                      " Color para l√≠neas a√±adidas en comparaci√≥n
    highlight DiffChange ctermbg=Yellow                  " Color para l√≠neas cambiadas en comparaci√≥n
    highlight DiffDelete ctermbg=Red                     " Color para l√≠neas eliminadas en comparaci√≥n
    highlight Folded ctermfg=White ctermbg=DarkBlue      " Color para l√≠neas plegadas

    " Mostrar la l√≠nea de estado
    set laststatus=2
    " Desactivar el sonido de campana
    set noerrorbells
    " Guardar el historial de comandos
    set history=1000
    " habilitar copiar y pegar desde ssh
    set clipboard=unnamedplus
----------------------------------------------------------------------------

#=========================================================================================================================
[‚õ©Ô∏èCONFIGURACI√ìN DE IPTABLES]::
# Compruebo la instalaci√≥n
sudo iptables -L

# configuro archivo iptables firewall ip4
vim /etc/iptables/rules.v4

üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±
# ‚ö†Ô∏è este archivo lo he configurado al final del proyecto, con todas las m√°quinas terminadas
----------------------------------------------------------------------------
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# tr√°fico local
-A INPUT -i lo -j ACCEPT

# tr√°fico bridge de LXC
-A INPUT -i br0 -j ACCEPT
-A FORWARD -i br0 -j ACCEPT
-A FORWARD -o br0 -j ACCEPT

# Aceptar conexiones ya establecidas
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# ssh
-A INPUT -p tcp --dport 22 -j ACCEPT

# üö® zabbix
# agent
-A INPUT -p tcp --dport 10050 -j ACCEPT
# SNMP
-A INPUT -p udp --dport 161 -j ACCEPT

# üêç greenbone
# panel web
-A INPUT -p tcp --dport 9392 -j ACCEPT

# üíÉ samba 
-A INPUT -p udp -s 192.168.1.0/16 --dport 137 -j ACCEPT
-A INPUT -p udp -s 192.168.1.0/16 --dport 138 -j ACCEPT
-A INPUT -p tcp -s 192.168.1.0/16 --dport 139 -j ACCEPT
-A INPUT -p tcp -s 192.168.1.0/16 --dport 445 -j ACCEPT

# ü¶ñ Velociraptor
# Frontend y agent
-A INPUT -p tcp --dport 8000 -j ACCEPT
-A INPUT -p tcp --dport 8001 -j ACCEPT

# ü™∂ apache
# http
-A INPUT -p tcp --dport 80 -j ACCEPT
# https
-A INPUT -p tcp --dport 443 -j ACCEPT
# mysql
-A INPUT -p tcp --dport 3306 -j ACCEPT

# üöÄ nginx
# node
-A INPUT -p tcp --dport 3000 -j ACCEPT
# mongo
-A INPUT -p tcp --dport 27017 -j ACCEPT

# ...
COMMIT
----------------------------------------------------------------------------

# Compruebo la configuraci√≥n
sudo iptables -L

#=========================================================================================================================
[‚õ©Ô∏èCONFIGURACI√ìN DE FAIL2BAN]::
# Modifico las variables del siguiente archivo
vim /etc/fail2ban/jail.conf
----------------------------------------------------------------------------
# Modifico todas las siguientes variables
    [DEFAULT]
    ## Tiempo que la IP estar√° bloqueada
    bantime = 1h
    ## Tiempo de intentos fallidos
    findtime = 10m
    ## N√∫mero m√°ximo de intentos
    maxretry = 5

    [sshd]
    ## Permito conexi√≥n SSH
    enabled = true
    port = 22
    filter = sshd
    logpath = /var/log/auth.log

----------------------------------------------------------------------------

# creo el archivo
touch /var/log/auth.log

# Reinicio el servicio y lo habilito para su reinicio
systemctl start fail2ban
systemctl status fail2ban
systemctl enable fail2ban
