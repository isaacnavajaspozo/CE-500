#=========================================================================================================================
[üêãWHITE WHALE]::
# üìÑüö´ No puedo utilizar dockerfiles porque me han pedido desde el centro que realice las instalaciones como si fuesen servidores independientes
# üìÑüö´ Es decir que la idea de utilizar docker-compose me sirve solo para dividir en una misma m√°quina los distintos servidores


#=========================================================================================================================
[üêãCREAR IM√ÅGENES DE DOCKER-COMPOSE]::
# Entrar en la ruta
cd /docker-compose

# Crear docker-compose de la m√°quina 1 (Samba)
vim docker-compose-samba.yml
----------------------------------------------------------------------------
version: "3.9"  # √öltima versi√≥n y estable
# modo bridge por defecto

services:
  vm1-samba:
    image: debian                          # Usamos la imagen de Debian
    hostname: vm1-samba.whitewhale.local   # Nuevo nombre del host
    container_name: vm1-samba              # El nombre del contenedor
    command: bash                          # Comando que se ejecutar√° cuando el contenedor se inicie
    ports:
      - "445:445"                          # Mapea el puerto TCP 445
      - "139:139"                          # Mapea el puerto TCP 139
      - "137:137/udp"                      # Mapea el puerto UDP 137
      - "138:138/udp"                      # Mapea el puerto UDP 138
    volumes:
      - vol-vm1-samba:/docker-volume       # Montamos el volumen en el contenedor
    tty: true                              # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                       # Permite interacci√≥n con el contenedor (similar a -it)
    # command: sleep infinity                # Mantiene el contenedor en ejecuci√≥n para configurarlo manualmente

volumes:
  vol-vm1-samba:                           # Definimos el volumen
----------------------------------------------------------------------------

# Crear docker-compose de la m√°quina 2 (Pentesting)
# esta m√°quina la creo en modo host ya que la voy a utilizar como red-team y pruebas de penetraci√≥n y no quiero estar dependiendo de gestionar puertos debido a que no voy a conocer las necesidades futuras
vim docker-compose-pentesting.yml
----------------------------------------------------------------------------
version: "3.9"
services:
  vm2-pentesting:
    image: kalilinux/kali-rolling                  # Usamos la imagen de Kali
    hostname: vm2-pentesting.whitewhale.local      # Nuevo nombre del host
    container_name: vm2-pentesting                 # El nombre del contenedor
    command: bash                                  # Comando que se ejecutar√° cuando el contenedor se inicie
    network_mode: host                             # Usa la red del host
    volumes:
      - vol-vm2-pentesting:/docker-volume          # Montamos el volumen en el contenedor
    tty: true                                      # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                               # Permite interacci√≥n con el contenedor (similar a -it)

volumes:
  vol-vm2-pentesting:                              # Definimos el volumen
----------------------------------------------------------------------------

-

# Crear docker-compose de la m√°quina 3 (BitWarden)
vim docker-compose-bitwarden.yml
----------------------------------------------------------------------------
version: "3.9"  # √öltima versi√≥n y estable
# modo bridge por defecto

services:
  vm3-bitwarden:
    image: debian                                  # Usamos la imagen de Debian
    hostname: vm3-bitwarden.whitewhale.local       # Nuevo nombre del host
    container_name: vm3-bitwarden                  # El nombre del contenedor ser√° vm1-smb
    command: bash                                  # Comando que se ejecutar√° cuando el contenedor se inicie
    ports:
      - "8080:80"                                  # Mapea el puerto 80 (HTTP) a 8080
      - "8443:443"                                 # Mapea el puerto 443 (HTTPS) a 8443
    volumes:
      - vol-vm3-bitwarden:/docker-volume           # Montamos el volumen en el contenedor
    tty: true                                      # Mantiene el contenedor en ejecuci√≥n
    stdin_open: true                               # Permite interacci√≥n con el contenedor

volumes:
  vol-vm3-bitwarden:                                # Definimos el volumen
----------------------------------------------------------------------------

# Crear docker-compose de la m√°quina 4 (Greenbone)
vim docker-compose-greenbone.yml
----------------------------------------------------------------------------
version: "3.9"                                        # √öltima versi√≥n y estable

services:
  vm4-greenbone:
    image: debian                                     # Usamos la imagen de Debian
    hostname: vm4-greenbone.whitewhale.local
    container_name: vm4-greenbone                     # El nombre del contenedor ser√° vm1-smb
    command: bash                                     # Comando que se ejecutar√° cuando el contenedor se inicie
    network_mode: host                                # El contenedor usar√° la red del host
    volumes:
      - vol-vm4-greenbone:/docker-volume              # Montamos el volumen en el contenedor
    tty: true                                         # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                                  # Permite interacci√≥n con el contenedor (similar a -it)
 
volumes:
  vol-vm4-greenbone:                                  # Definimos el volumen que usaremos
----------------------------------------------------------------------------

# Crear docker-compose de la m√°quina 5 (OpenEDR)
vim docker-compose-openedr.yml
----------------------------------------------------------------------------
version: "3.9"                                        # √öltima versi√≥n y estable

services:
  vm5-openedr:
    image: debian                                     # Usamos la imagen de Debian
    hostname: vm5-openedr.whitewhale.local
    container_name: vm5-openedr                       # El nombre del contenedor ser√° vm1-smb
    command: bash                                     # Comando que se ejecutar√° cuando el contenedor se inicie
    network_mode: host                                # El contenedor usar√° la red del host
    volumes:
      - vol-vm5-openedr:/docker-volume                # Montamos el volumen en el contenedor
    tty: true                                         # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                                  # Permite interacci√≥n con el contenedor (similar a -it)
 
volumes:
  vol-vm5-openedr:                                    # Definimos el volumen que usaremos
----------------------------------------------------------------------------

# Crear docker-compose de la m√°quina 6 (Nginx)
vim docker-compose-web.yml
----------------------------------------------------------------------------
version: "3.9"                                        # √öltima versi√≥n y estable

services:
  vm6-web:
    image: debian                                     # Usamos la imagen de Debian
    hostname: vm6-nginx.whitewhale.local
    container_name: vm6-nginx                         # El nombre del contenedor ser√° vm1-smb
    command: bash                                     # Comando que se ejecutar√° cuando el contenedor se inicie
    network_mode: host                                # El contenedor usar√° la red del host
    volumes:
      - vol-vm6-nginx:/docker-volume                  # Montamos el volumen en el contenedor
    tty: true                                         # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                                  # Permite interacci√≥n con el contenedor (similar a -it)
 
volumes:
  vol-vm6-nginx:                                      # Definimos el volumen que usaremos
----------------------------------------------------------------------------

# Crear docker-compose de la m√°quina 6 (Apache)
vim docker-compose-web.yml
----------------------------------------------------------------------------
version: "3.9"                                        # √öltima versi√≥n y estable

services:
  vm7-web:
    image: debian                                     # Usamos la imagen de Debian
    hostname: vm7-apache.whitewhale.local
    container_name: vm7-apache                        # El nombre del contenedor ser√° vm1-smb
    command: bash                                     # Comando que se ejecutar√° cuando el contenedor se inicie
    network_mode: host                                # El contenedor usar√° la red del host
    volumes:
      - vol-vm7-apache:/docker-volume                 # Montamos el volumen en el contenedor
    tty: true                                         # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                                  # Permite interacci√≥n con el contenedor (similar a -it)
 
volumes:
  vol-vm7-apache:                                     # Definimos el volumen que usaremos
----------------------------------------------------------------------------

# Crear docker-compose de la m√°quina 7 (Nagios)
vim docker-compose-nagios.yml
----------------------------------------------------------------------------
version: "3.9"                                        # √öltima versi√≥n y estable

services:
  vm8-nagios:
    image: debian                                     # Usamos la imagen de Debian
    hostname: vm8-nagios.whitewhale.local
    container_name: vm8-nagios                        # El nombre del contenedor ser√° vm1-smb
    command: bash                                     # Comando que se ejecutar√° cuando el contenedor se inicie
    network_mode: host                                # El contenedor usar√° la red del host
    volumes:
      - vol-vm7-nagios:/docker-volume                 # Montamos el volumen en el contenedor
    tty: true                                         # Mantiene el contenedor en ejecuci√≥n (similar a -it)
    stdin_open: true                                  # Permite interacci√≥n con el contenedor (similar a -it)
 
volumes:
  vol-vm8-nagios:                                     # Definimos el volumen que usaremos
----------------------------------------------------------------------------


#=========================================================================================================================
[üêãCREAR ALIAS EN SERVIDOR PRINCIPAL]::
## TEORIA :: Datos y posibilidades a tener en cuenta para crear alias
# üßë‚Äçüéì En el caso de lanzar una m√°quina en segundo plano (modo detached)
# docker-compose -f /docker-compose/docker-compose-samba.yml up -d
# üßë‚Äçüéì Si se ejecuta el modo detached no se detendr√° hasta forzar su detecci√≥n (aunque salga y entre de la m√°quina)
# docker stop <nombre_del_contenedor>
# üßë‚Äçüéì En el caso de que se haya inicializado en segundo plano, para acceder despu√©s a la m√°quina se har√° de la siguiente manera
# docker exec -it vm1-samba bash
# üßë‚Äçüéì Para iniciar una m√°quina directamente que no se quiera ejecutar en segundo plano si no interactuar con su terminal
docker start -i vm1-samba

# creo un script para ejecutar r√°pidamente las m√°quinas
cd /docker-volume
touch docker-manager.sh

# doy permiso de ejecuci√≥n
chmod +x docker-manager.sh

[SCRIPT docker-manager.sh]:
--------------------------------------------------------------------------------------------------------------------------
  # Guardo el script que tengo en /SCRIPT/docker-manager.sh
--------------------------------------------------------------------------------------------------------------------------

# Entro a bashrc
vim ~/.bashrc
--------------------------------------------------------------------------------------------------------------------------
## alias para ejecutar el script principal de las m√°quinas
alias _docker-manager="/docker-compose/docker-manager.sh"
--------------------------------------------------------------------------------------------------------------------------

# actualizo los cambios 
source ~/.bashrc

# ejecuto script
_docker-manager


#=========================================================================================================================
[üêãüî•DENTRO DE LA M√ÅQUINA DOCKER]:
## Repito este bloque por cada m√°quina:
# Desde la m√°quina principal creo el script como ejecutable
# Ver direcci√≥n f√≠sica del volumen
cd /var/lib/docker/volumes/

# Compruebo alias, por ejemplo pentesting
 _vm2.pentesting

# actualizo los paquetes del contenedor
apt-get update

# creo un archivo 
cd /docker-volume
touch script-00.sh

# doy permiso de ejecuci√≥n
chmod +x script-00.sh

# instalo nano y pego el c√≥digo
apt install nano -y
nano script-00.sh

[SCRIPT script-00.sh]:
--------------------------------------------------------------------------------------------------------------------------
  # Guardo el script que tengo en /SCRIPT/script-00.sh
--------------------------------------------------------------------------------------------------------------------------

# Ejecuto el script 
/docker-volume/script-00.sh

# Salir de la m√°quina
exit

#=========================================================================================================================
[üêãCOMPROBAR VOLUMEN]::
# Con docker-compose le mando crear un volumen por lo que una vez generada la m√°quina no es necesario crear su volumen, pero puedo comprobar que existen solo los necesarios 
# Esto quiere decir que si borro alg√∫n docker-compose tengo que eliminar de forma independiente su volumen

# Ver volumenes 
docker volume ls

# Ver direcci√≥n f√≠sica del volumen
cd /var/lib/docker/volumes/

# Creo volumen si no est√° creado
# docker volume create vol-vm2-smb

# Borrar volumen
# docker volume rm <nombre_del_volumen>

