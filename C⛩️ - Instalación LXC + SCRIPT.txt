#=========================================================================================================================
[‚õ©Ô∏èKIRIBAKO]::
# Guia de oficial instalaci√≥n LXC      : https://linuxcontainers.org/#navigation
# Guia no oficial                      : https://www.josedomingo.org/pledin/2021/12/introduccion-lxc/

#=========================================================================================================================
[‚õ©Ô∏èRESUMEN PROYECTO ¬∑ M√ÅQUINAS LABORATOR√çO]:
# üßë‚Äçüéì Dentro de un servidor Debian, voy a crear unas m√°quinas virtuales con LXC (Linux Containers). Ya que lo que quiero es crear m√°quinas independientes con distintos servicios.
# üßë‚Äçüéì Voy a crear un script para hacer m√°s sencillo la utilizaci√≥n e instalaci√≥n de LXC
#      Configuraci√≥n de los contenedores LXC      :: cat /etc/lxc/default.conf
#      Sistema de archivos del contenedor         :: cd /var/lib/lxc/<NOMBRE_CONTENEDOR>/rootfs/
#      Listar todas las plantillas                :: ls /usr/share/lxc/templates/
#      Configuraci√≥n de red del contenedor        :: cat /var/lib/lxc/<NOMBRE_CONTENEDOR>/config


#=========================================================================================================================
[‚õ©Ô∏èMANUAL DE FUNCIONAMIENTO LXC]:
# üßë‚Äçüéì Este paso lo dejo para conocer los comandos que voy hacer por debajo pero lo quiero qutomatizar con el script del siguiente apartado
# üì¶ Instalaci√≥n en Debian
sudo apt update
sudo apt install lxc lxc-templates bridge-utils

# üß± Crear un contenedor Debian
sudo lxc-create -n vm-samba -t debian

# üîå Iniciar el contenedor (segundo plano) : esto es para que aunque salga con "exit" seguir√° encendido
sudo lxc-start -n vm-samba -d

# üèóÔ∏è Comprobar que est√° en ejecuci√≥n
sudo lxc-info -n vm-samba
# ü´∏ Detener el contenedor
sudo lxc-stop -n vm-samba
# üìÑ Listar 
lxc-ls --fancy

# üì≤ Acceder al contenedor
sudo lxc-attach -n vm-samba


#=========================================================================================================================
[‚õ©Ô∏èINSTALACI√ìN]:
sudo apt update
sudo apt install lxc

#=========================================================================================================================
[‚õ©Ô∏èINSTALACI√ìN DE SCRIPT]:
# creo carpeta en servidor principal
cd / && mkdir KIRIBAKO
cd /KIRIBAKO

# creo script
vim lxc-manager.sh
---------------------------------------------------------------------------------
#!/bin/bash

# Funci√≥n para mostrar el men√∫
mostrar_menu() {
    # Mostrar estado actual de los contenedores
    echo "Estado actual de los contenedores:"
    lxc-ls --fancy
    echo ""

    echo " ____  __..__         .__ ___.             __      "
    echo "|    |/ _||__|_______ |__|\_ |__  _____   |  | __  ____"
    echo "|      /  |  |\_  __ \|  | | __ \ \__  \  |  |/ / /  _ \ "
    echo "|    |  \ |  | |  | \/|  | | \_\ \ / __ \_|    < (  <_> )"
    echo "|____|__ \|__| |__|   |__| |___  /(____  /|__|_ \ \____/ "
    echo "        \/                     \/      \/      \/        "

    # Mostrar men√∫ de opciones
    echo "¬øQu√© deseas hacer?"
    echo "1) Crear una nueva m√°quina"
    echo "2) Iniciar una m√°quina en segundo plano"
    echo "3) Acceder a una m√°quina"
    echo "4) Parar una m√°quina"
    echo "5) Eliminar una m√°quina"
    echo "6) Salir"
    read -p "Elige una opci√≥n [1-6]: " opcion

    case $opcion in
        1)
            # Selecci√≥n del tipo de sistema operativo
            echo "¬øQu√© sistema operativo deseas para la m√°quina?"
            echo "1) Debian"
            echo "2) Ubuntu"
            echo "3) Kali"
            read -p "Elige una opci√≥n [1-3]: " so

            case $so in
                1)
                    tipo_so="debian"
                    ;;
                2)
                    tipo_so="ubuntu"
                    ;;
                3)
                    tipo_so="kali"
                    ;;
                *)
                    echo "Opci√≥n no v√°lida. Se usar√° Debian por defecto."
                    tipo_so="debian"
                    ;;
            esac

            # Nombre de la nueva m√°quina
            read -p "Introduce el nombre de la nueva m√°quina: " nombre
            sudo lxc-create -n "$nombre" -t "$tipo_so"
            ;;
        2)
            read -p "Introduce el nombre de la m√°quina a iniciar: " nombre
            sudo lxc-start -n "$nombre" -d
            ;;
        3)
            read -p "Introduce el nombre de la m√°quina a la que quieres acceder: " nombre
            sudo lxc-attach -n "$nombre"
            ;;
        4)
            read -p "Introduce el nombre de la m√°quina que deseas parar: " nombre
            sudo lxc-stop -n "$nombre"
            ;;
        5)
            read -p "Introduce el nombre de la m√°quina que deseas eliminar: " nombre
            sudo lxc-destroy -n "$nombre"
            ;;
        6)
            echo "Saliendo del script..."
            exit 0
            ;;
        *)
            echo "Opci√≥n no v√°lida."
            ;;
    esac
}

# Bucle que muestra el men√∫ hasta que el usuario decida salir
while true; do
    mostrar_menu
done
---------------------------------------------------------------------------------

# doy permisos 
chmod +x lxc-manager.sh

# ejecuto el script
./lxc-manager.sh

#=========================================================================================================================
[‚ö†Ô∏èSOLUCIONES]:
- ‚ö†Ô∏è systemctl (error PID 1)
# si en alg√∫n momento me da un error en los contenedores con systemctl agrego lo siguiente
/var/lib/lxc/<nombre>/config
Y aseg√∫rate de tener lo siguiente:

# Usar systemd como PID 1
lxc.init.cmd = /lib/systemd/systemd
# Montar cgroups y sistemas necesarios
lxc.mount.auto = proc sys cgroup
lxc.mount.entry = /dev/fuse dev/fuse none bind,create=file 0 0
-
